I"ı<h2 id="m√≥dulos-do-kernel-no-linux">M√≥dulos do Kernel no Linux</h2>

<p>Vimos em aula que m√≥dulos s√£o arquivos-objeto, parte do kernel, que s√£o vinculados a ele em tempo de execu√ß√£o.</p>

<p>Um m√≥dulo no linux √© um c√≥digo, geralmente drivers de dispositivos que podem ser carregados e descarregados sem a necessidade de reiniciar o sistema.</p>

<p>Os m√≥dulos podem ser inseridos e removidos em um kernel em execu√ß√£o a qualquer tempo, exceto quando em uso.</p>

<p>Os arquivos de drivers geralmente terminam com a extens√£o .ko (ou .o) e s√£o armazenados em subdiret√≥rios dentro de /lib/modules</p>

<h3 id="comandos-para-gerenciamento-de-m√≥dulos">Comandos para Gerenciamento de M√≥dulos</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">depmod</code> - Trabalha com depend√™ncias dos m√≥dulos</li>
  <li><code class="language-plaintext highlighter-rouge">insmod</code> - Carrega m√≥dulos em um kernel em execu√ß√£o</li>
  <li><code class="language-plaintext highlighter-rouge">lsmod</code>  - Lista informa√ß√µes sobre m√≥dulos carregados</li>
  <li><code class="language-plaintext highlighter-rouge">modinfo</code> - Lista informa√ß√µes sobre um m√≥dulo</li>
  <li><code class="language-plaintext highlighter-rouge">modprobe</code> - Carrega, descarrega e gera relat√≥rios em m√≥dulos, e trata de suas depend√™ncias</li>
  <li><code class="language-plaintext highlighter-rouge">rmmod</code> - Descarrega m√≥dulos de um kernel em execu√ß√£o</li>
</ul>

<h3 id="criando-um-m√≥dulo-no-linux">Criando um m√≥dulo no Linux</h3>

<ul>
  <li>s√£o executados no espa√ßo do kernel;</li>
  <li>s√≥ podem executar fun√ß√µes definidas pelo kernel;</li>
  <li>s√£o orientados a eventos (executam uma determinada tarefa apenas quando recebem uma solicita√ß√£o);</li>
  <li>possuem uma fun√ß√£o de inicializa√ß√£o que o prepara para receber as solicita√ß√µes;</li>
  <li>possuem uma fun√ß√£o de finaliza√ß√£o que libera os recursos alocados antes da desinstala√ß√£o.</li>
</ul>

<p>Exemplo, Hello World!</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;linux/module.h&gt; 
</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"Dual BSD/GPL"</span><span class="p">);</span> 
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">"Amaury Andr√©"</span><span class="p">);</span> 
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">"Um modulo simples!"</span><span class="p">);</span> 
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">"0.1"</span><span class="p">);</span> 

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alo_inicio</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">"Alo, Mundo!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
<span class="p">}</span> 

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alo_fim</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">printk</span><span class="p">(</span><span class="s">"Adeus, Mundo Cruel!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> 
<span class="p">}</span> 

<span class="n">module_init</span><span class="p">(</span><span class="n">alo_inicio</span><span class="p">);</span> 
<span class="n">module_exit</span><span class="p">(</span><span class="n">alo_fim</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">MODULE_LICENSE()</code> ‚Äì esta macro informa a licen√ßa do m√≥dulo (no exemplo, o c√≥digo √© disponibilizado sob as licen√ßas BSD e GPL).</li>
  <li><code class="language-plaintext highlighter-rouge">module_init()</code> ‚Äì macro que define quais fun√ß√µes s√£o chamadas quando o m√≥dulo √© carregado. Neste exemplo, apenas a fun√ß√£o alo_inicio() √© chamada.</li>
  <li><code class="language-plaintext highlighter-rouge">module_exit()</code> ‚Äì macro que define quais fun√ß√µes s√£o chamadas antes do m√≥dulo ser removido. Neste exemplo, apenas a fun√ß√£o alo_fim() √© chamada.</li>
  <li><code class="language-plaintext highlighter-rouge">printk()</code> ‚Äì fun√ß√£o que escreve mensagens do kernel em /var/log/syslog.</li>
</ul>

<p>Para compilar e gerar o arquivo .ko do m√≥dulo, crie o arquivo Makefile.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>obj-m :<span class="o">=</span> alomundo.o 

all: 
       make <span class="nt">-C</span> /lib/modules/<span class="si">$(</span>shell <span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="si">$(</span>PWD<span class="si">)</span> modules 

clean: 
       make <span class="nt">-C</span> /lib/modules/<span class="si">$(</span>shell <span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="si">$(</span>PWD<span class="si">)</span> clean
</code></pre></div></div>
<ul>
  <li>obj-m ‚Äì especifica os arquivos-objeto que ser√£o usados para gerar os m√≥dulos carreg√°veis do kernel. Neste exemplo, ser√° usado o arquivo alomundo.o para gerar o arquivo alomundo.ko.</li>
  <li>-C diret√≥rio ‚Äì esta op√ß√£o muda para o diret√≥rio especificado antes de ler o Makefile (vai usar esse ambiente na gera√ß√£o dos m√≥dulos).</li>
  <li>M diret√≥rio modules ‚Äì vai para o diret√≥rio especificado antes de gerar os m√≥dulos (os arquivos ser√£o armazenados nesse diret√≥rio).</li>
</ul>

<p>Execute o comando <code class="language-plaintext highlighter-rouge">make</code> para compilar o m√≥dulo.</p>

<h3 id="carregando-o-m√≥dulo">Carregando o m√≥dulo</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">sudo insmod alomundo.ko</code></li>
</ul>

<h3 id="verificando-o-m√≥dulo">Verificando o m√≥dulo</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">lsmod</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">less /proc/modules</code></p>
  </li>
</ul>

<h3 id="informa√ß√µes-do-m√≥dulo">Informa√ß√µes do m√≥dulo</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">modinfo alomundo.ko</code></li>
</ul>

<h3 id="removendo-o-m√≥dulo">Removendo o m√≥dulo</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">sudo rmmod alomundo</code></li>
</ul>

<h3 id="log-do-sistema">Log do sistema</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">dmesg</code></li>
</ul>

<h3 id="par√¢metros">Par√¢metros</h3>

<p>Passados em user-space para o insmod/modprobe.</p>

<p>Exemplo:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">insmod meu_modulo.ko numero=3</code></li>
</ul>

<p>Tipos de dados padr√£o:</p>

<ul>
  <li>Byte</li>
  <li>(u)short</li>
  <li>(u)int</li>
  <li>(u)long</li>
  <li>charp</li>
  <li>Bool</li>
</ul>

<p>Exemplo:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span><span class="err">¬†</span><span class="n">numero</span><span class="p">;</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">numero</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="exerc√≠cio-extra">Exerc√≠cio extra:</h3>

<p>Criar 1 m√≥dulo que recebe um n√∫mero inteiro e uma string como par√¢metro e imprime a string o n√∫mero desejado de vezes.</p>

<h3 id="conclus√£o">Conclus√£o</h3>

<p>Vimos neste artigo alguns comandos relacionados a m√≥dulos do Linux. Este assunto √© parte do t√≥pico 101 da certifica√ß√£o Linux LPIC-1.</p>

:ET